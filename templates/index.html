<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í”„ë¡œì íŠ¸ ê´€ë¦¬</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Flatpickr (Calendar) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ko.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .history-card, .todo-card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            transition: transform 0.2s;
        }
        .history-card:hover {
            transform: translateY(-2px);
        }
        .tab-active {
            border-bottom-color: #3b82f6; /* Blue 500 */
            color: #3b82f6;
            font-weight: 600;
        }
        /* ìƒíƒœ ì•„ì´ì½˜ ìŠ¤íƒ€ì¼ */
        .status-icon {
            font-size: 1.25rem; /* text-xl */
            margin-right: 8px;
            width: 20px; /* ê³ ì • ë„ˆë¹„ */
            text-align: center;
        }
        .status-completed {
            color: #10b981; /* Green 500 */
        }
        .status-pending {
            color: #ef4444; /* Red 500 */
        }
        /* Flatpickr Event Dot Style */
        .flatpickr-day.has-event {
            font-weight: bold;
        }
        .flatpickr-day.has-event::after {
            content: '';
            position: absolute;
            bottom: 4px;
            left: 50%;
            transform: translateX(-50%);
            width: 6px;
            height: 6px;
            background-color: #3b82f6; /* blue-500 */
            border-radius: 50%;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-extrabold text-gray-900 mb-4">ğŸ“œ í”„ë¡œì íŠ¸ ê´€ë¦¬ <span class="text-sm text-blue-500 font-medium align-middle">v0.1.2</span></h1>

        <!-- GitHub Connection Section -->
        <div class="mb-6 p-4 bg-gray-100 rounded-xl flex flex-col space-y-3 shadow-inner border border-gray-200">
            <!-- 0. í”„ë¡œì íŠ¸ëª… ì…ë ¥ ê·¸ë£¹ (ì¶”ê°€ë¨) -->
            <div class="flex flex-col md:flex-row items-start md:items-center space-y-2 md:space-y-0 md:space-x-3">
                <span class="font-bold text-gray-700 whitespace-nowrap flex-shrink-0 w-24">ğŸ·ï¸ í”„ë¡œì íŠ¸ëª…:</span>
                <input type="text" id="projectName" placeholder="í”„ë¡œì íŠ¸ ë³„ì¹­ (ì˜ˆ: ë‚´ í”„ë¡œì íŠ¸ 1)"
                       value="{{ project_name if project_name else '' }}"
                       class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 text-gray-700 text-sm w-full md:w-auto">
            </div>

            <!-- 1. URL ì…ë ¥ ê·¸ë£¹ -->
            <div class="flex flex-col md:flex-row items-start md:items-center space-y-2 md:space-y-0 md:space-x-3">
                <span class="font-bold text-gray-700 whitespace-nowrap flex-shrink-0 w-24">ğŸ”— URL:</span>
                <input type="text" id="githubUrl" placeholder="ì—¬ê¸°ì— GitHub ì €ì¥ì†Œ URLì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: owner/repo)"
                       value="https://github.com/IndyPD/test_project"
                       class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 text-gray-700 text-sm w-full md:w-auto">
            </div>

            <!-- 2. Branch ì…ë ¥ ë° ì—°ê²° ë²„íŠ¼ ê·¸ë£¹ -->
            <div class="flex flex-col md:flex-row items-start md:items-center space-y-2 md:space-y-0 md:space-x-3">
                <span class="font-bold text-gray-700 whitespace-nowrap flex-shrink-0 w-24">ğŸŒ¿ Branch:</span>
                <input type="text" id="branchName" placeholder="ë¸Œëœì¹˜ ì´ë¦„ (ì˜ˆ: main, master, dev)"
                       value="{{ github_raw_branch if github_raw_branch is defined else 'main' }}"
                       class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 text-gray-700 text-sm w-full md:w-auto">
                
                <!-- Token Input -->
                <span class="font-bold text-gray-700 whitespace-nowrap flex-shrink-0 ml-2">ğŸ”‘ Token:</span>
                <input type="password" id="githubToken" placeholder="Private Repo Access Token (Optional)"
                       value="{{ github_token if github_token else '' }}"
                       class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 text-gray-700 text-sm w-full md:w-auto">

                <!-- ì—°ê²° ë²„íŠ¼ -->
                <button id="connectButton" 
                        class="w-full md:w-auto px-4 py-2 bg-purple-600 text-white font-semibold rounded-lg hover:bg-purple-700 transition duration-150 shadow-md flex-shrink-0">
                    GitHub ì—°ê²°
                </button>
            </div>
        </div>


        <!-- View Selector Tabs -->
        <div class="flex border-b border-gray-200 mb-6">
            <button id="tabHistory" data-view="history" class="view-tab p-3 text-lg text-gray-500 border-b-2 border-transparent hover:text-gray-700 transition duration-150 tab-active">
                í”„ë¡œì íŠ¸ ê°œë°œ ê¸°ë¡ (History)
            </button>
            <button id="tabTodo" data-view="todo" class="view-tab p-3 text-lg text-gray-500 border-b-2 border-transparent hover:text-gray-700 transition duration-150 ml-4">
                í•  ì¼ ëª©ë¡ (To-Do)
            </button>
            <!-- Raw íŒŒì¼ ë·° íƒ­ ì¶”ê°€ -->
            <button id="tabRaw" data-view="raw" class="view-tab p-3 text-lg text-gray-500 border-b-2 border-transparent hover:text-gray-700 transition duration-150 ml-4">
                Raw íŒŒì¼
            </button>
            <!-- í”„ë¡œì íŠ¸ ëª©ë¡ íƒ­ ì¶”ê°€ -->
            <button id="tabProjectList" data-view="projectList" class="view-tab p-3 text-lg text-gray-500 border-b-2 border-transparent hover:text-gray-700 transition duration-150 ml-4">
                ğŸ“‚ í”„ë¡œì íŠ¸ ëª©ë¡
            </button>
        </div>

        <!-- Date Filter UI (History View Only) -->
        <div id="filterContainer" class="mb-8 p-4 bg-white rounded-lg shadow-inner flex flex-col sm:flex-row items-center space-y-4 sm:space-y-0 sm:space-x-4">
            <!-- ë‚ ì§œ ì„ íƒ í•„ë“œ -->
            <input type="text" id="dateFilter" placeholder="ë‚ ì§œ ì„ íƒ"
                   class="w-full sm:w-40 p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-gray-700">
            <!-- ê²€ìƒ‰ ë²„íŠ¼ -->
            <button id="filterButton"
                    class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition duration-150 shadow-md whitespace-nowrap">
                ê²€ìƒ‰
            </button>
            <!-- ì „ì²´ ë³´ê¸° ë²„íŠ¼ -->
            <button id="resetButton"
                    class="px-6 py-3 bg-gray-400 text-white font-semibold rounded-lg hover:bg-gray-500 transition duration-150 shadow-md whitespace-nowrap">
                ì „ì²´ ë³´ê¸°
            </button>
        </div>

        <!-- Content Area -->
        <div id="contentArea" class="space-y-6">
            <p id="noResults" class="text-center text-gray-500 hidden py-10">ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>
    </div>

    <!-- Edit Project Modal -->
    <div id="editModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
        
        <div class="modal-container bg-white w-11/12 md:max-w-2xl mx-auto rounded shadow-lg z-50 overflow-y-auto max-h-[90vh]">
            <div class="modal-content py-4 text-left px-6">
                <!-- Title -->
                <div class="flex justify-between items-center pb-3 border-b">
                    <p class="text-2xl font-bold text-gray-800">âœï¸ í”„ë¡œì íŠ¸ ì •ë³´ ìˆ˜ì •</p>
                    <div class="modal-close cursor-pointer z-50" id="editModalCloseBtn">
                        <svg class="fill-current text-black" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 18 18">
                            <path d="M14.53 4.53l-1.06-1.06L9 7.94 4.53 3.47 3.47 4.53 7.94 9l-4.47 4.47 1.06 1.06L9 10.06l4.47 4.47 1.06-1.06L10.06 9z"></path>
                        </svg>
                    </div>
                </div>

                <!-- Edit Form -->
                <div class="my-5 space-y-4">
                    <input type="hidden" id="editOriginalUrl">
                    <input type="hidden" id="editOriginalBranch">
                    
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">í”„ë¡œì íŠ¸ëª…</label>
                        <input type="text" id="editProjectName" class="w-full p-2 border rounded">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">URL</label>
                        <input type="text" id="editUrl" class="w-full p-2 border rounded">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Branch</label>
                        <input type="text" id="editBranch" class="w-full p-2 border rounded">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Token (Optional)</label>
                        <input type="password" id="editToken" class="w-full p-2 border rounded">
                    </div>
                </div>

                <!-- Footer -->
                <div class="flex justify-end pt-2">
                    <button id="saveEditBtn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 mr-2">ì €ì¥</button>
                    <button id="cancelEditBtn" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">ì·¨ì†Œ</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DATA DEFINITION (Jinja2ë¥¼ í†µí•´ Python ë°ì´í„° ì£¼ì…) ---
        // Flask ë°±ì—”ë“œì—ì„œ ì „ë‹¬ëœ ë°ì´í„°ë¥¼ JavaScript ë³€ìˆ˜ì— í• ë‹¹í•©ë‹ˆë‹¤.
        const projectHistoryData = {{ history_data | tojson }};
        const todoData = {{ todo_data | tojson }};
        const CONNECTED_REPO_URL = '{{ github_repo_url if github_repo_url is defined else "https://github.com/IndyPD/test_project" }}';
        const CONNECTED_BRANCH = '{{ github_raw_branch if github_raw_branch is defined else "main" }}'; // ë°±ì—”ë“œì—ì„œ ë°›ì€ ë¸Œëœì¹˜ ì´ë¦„
        
        // Raw íŒŒì¼ ì½˜í…ì¸  ë³€ìˆ˜ ì¶”ê°€
        const rawHistoryContent = {{ raw_history_content | tojson }};
        const rawTodoContent = {{ raw_todo_content | tojson }};


        // --- GLOBAL STATE & ELEMENTS ---
        let currentView = 'history'; // 'history', 'todo', or 'raw'
        const contentArea = document.getElementById('contentArea');
        const dateFilterInput = document.getElementById('dateFilter');
        const filterContainer = document.getElementById('filterContainer');
        const projectNameInput = document.getElementById('projectName'); // Project Name input ì¶”ê°€
        const githubUrlInput = document.getElementById('githubUrl');
        const branchNameInput = document.getElementById('branchName'); // Branch input ì¶”ê°€
        const githubTokenInput = document.getElementById('githubToken'); // Token input ì¶”ê°€
        const noResults = document.getElementById('noResults');
        const connectButton = document.getElementById('connectButton'); 
        
        // Edit Modal Elements
        const editModal = document.getElementById('editModal');
        const editModalCloseBtn = document.getElementById('editModalCloseBtn');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const saveEditBtn = document.getElementById('saveEditBtn');

        // URL íŒŒë¼ë¯¸í„°ë¥¼ ì‚¬ìš©í•˜ì—¬ ì´ˆê¸° ë¡œë“œ ìƒíƒœë¥¼ í™•ì¸í•©ë‹ˆë‹¤.
        const urlParams = new URLSearchParams(window.location.search);
        const isInitialLoad = !urlParams.has('owner') && !urlParams.has('repo');

        // ì´ˆê¸° ë¡œë“œ ì‹œ ë°ì´í„° ë°°ì—´ì„ ë¹„ì›€ (ì—°ê²° ë²„íŠ¼ í´ë¦­ ì „ê¹Œì§€ UIì— ë©”ì‹œì§€ë¥¼ í‘œì‹œí•˜ê¸° ìœ„í•¨)
        if (isInitialLoad) {
            projectHistoryData.length = 0;
            todoData.length = 0;
        }


        // --- UTILITY FUNCTIONS ---
        /**
         * GitHub URL ë° Branch Nameì„ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ë¡œë“œí•˜ê³  ì…ë ¥ í•„ë“œì— ì„¤ì •í•©ë‹ˆë‹¤.
         */
        function loadSettings() {
            // 0. Project Name ë¡œë“œ
            const pName = localStorage.getItem('projectName');
            if (pName && !projectNameInput.value) {
                // ì„œë²„ì—ì„œ ê°’ì´ ì˜¤ì§€ ì•Šì•˜ì„ ë•Œë§Œ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì‚¬ìš©
                projectNameInput.value = pName;
            }

            // 1. URL ë¡œë“œ ë° ì„¤ì •
            const url = localStorage.getItem('githubUrl');
            if (url) {
                githubUrlInput.value = url;
            } else {
                githubUrlInput.value = CONNECTED_REPO_URL;
                localStorage.setItem('githubUrl', CONNECTED_REPO_URL);
            }

            // 2. Branch Name ë¡œë“œ ë° ì„¤ì •
            const branch = localStorage.getItem('branchName');
            if (branch) {
                branchNameInput.value = branch;
            } else {
                branchNameInput.value = CONNECTED_BRANCH;
                localStorage.setItem('branchName', CONNECTED_BRANCH);
            }

            // 3. Token ë¡œë“œ ë° ì„¤ì • (ì„œë²„ì—ì„œ ê°’ì´ ì˜¤ì§€ ì•Šì•˜ì„ ë•Œë§Œ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì‚¬ìš©)
            const token = localStorage.getItem('githubToken');
            if (token && !githubTokenInput.value) {
                githubTokenInput.value = token;
            }
        }

        /**
         * GitHub URL ë° Branch Name ì…ë ¥ í•„ë“œì˜ ê°’ì´ ë³€ê²½ë  ë•Œ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥í•©ë‹ˆë‹¤.
         */
        function saveSettings() {
            localStorage.setItem('projectName', projectNameInput.value);
            localStorage.setItem('githubUrl', githubUrlInput.value);
            localStorage.setItem('branchName', branchNameInput.value);
            localStorage.setItem('githubToken', githubTokenInput.value);
        }

        /**
         * GitHub URLì—ì„œ Ownerì™€ Repo ì´ë¦„ì„ ì¶”ì¶œí•©ë‹ˆë‹¤.
         * @param {string} url - GitHub URL
         * @returns { {owner: string, repo: string} | null}
         */
        function parseGithubUrl(url) {
            try {
                // 'https://github.com/owner/repo' í˜•íƒœë¥¼ ê°€ì •
                const parts = new URL(url).pathname.split('/').filter(p => p.length > 0);
                if (parts.length >= 2 && parts[0] && parts[1]) {
                    // .git í™•ì¥ì ì œê±°
                    return { owner: parts[0], repo: parts[1].replace('.git', '') };
                }
            } catch (e) {
                console.error("Invalid GitHub URL:", url, e);
            }
            return null;
        }

        // --- RENDER FUNCTIONS ---
        
        // Raw íŒŒì¼ ë‚´ìš©ì„ ë Œë”ë§í•˜ëŠ” í•¨ìˆ˜
        function renderRawFiles() {
            let rawHtml = `<h2 class="text-2xl font-bold text-gray-700 mb-6">GitHub Raw Markdown Files (Branch: ${CONNECTED_BRANCH})</h2>`;
            
            rawHtml += renderRawFileBlock("HISTORY.md", rawHistoryContent);
            rawHtml += renderRawFileBlock("TODO.md", rawTodoContent);
            
            contentArea.innerHTML = rawHtml;
        }
        
        // Raw íŒŒì¼ ë‚´ìš©ì„ í‘œì‹œí•˜ëŠ” ë¸”ë¡ì„ ë Œë”ë§
        function renderRawFileBlock(filename, content) {
            const isError = content.startsWith('--- ERROR:');
            const displayContent = isError ? 
                                   // ì˜¤ë¥˜ ë©”ì‹œì§€ ìŠ¤íƒ€ì¼
                                   `<pre class="bg-red-50 text-red-700 p-4 rounded-lg overflow-auto max-h-96 text-sm whitespace-pre-wrap">${content}</pre>` : 
                                   // ì •ìƒì ì¸ Markdown ë‚´ìš© ìŠ¤íƒ€ì¼
                                   `<pre class="bg-gray-800 text-gray-100 p-4 rounded-lg overflow-auto max-h-96 text-sm whitespace-pre-wrap">${content}</pre>`;

            return `
                <div class="todo-card bg-white p-6 rounded-xl border border-gray-200 mb-8">
                    <h3 class="text-xl font-extrabold text-gray-900 mb-3">${filename} (Raw Content)</h3>
                    ${displayContent}
                </div>
            `;
        }


        /**
         * History ê¸°ë¡ ì¹´ë“œë¥¼ HTMLë¡œ ë Œë”ë§í•©ë‹ˆë‹¤.
         */
        function renderHistoryCard(history) {
            // ì„¹ì…˜ ìˆœì„œë¥¼ ê³ ì •í•©ë‹ˆë‹¤ (1. Hardware -> 2. Software -> 3. Issues -> 4. Other)
            const sectionOrder = ['hardware', 'software', 'issues', 'other'];
            const sectionsHtml = sectionOrder.map(key => {
                const titleMap = {
                    hardware: "1. í•˜ë“œì›¨ì–´ (Hardware)",
                    software: "2. ì†Œí”„íŠ¸ì›¨ì–´ (Software)",
                    issues: "3. ì´ìŠˆ (Issues)",
                    other: "4. ê¸°íƒ€ (Other)"
                };
                const sectionTitle = titleMap[key] || key;
                const content = history.sections[key];

                // ë‚´ìš©ì´ ". "ìœ¼ë¡œ ì—°ê²°ë˜ì–´ ìˆë‹¤ê³  ê°€ì •í•˜ê³ , ì´ë¥¼ ë‹¤ì‹œ ë¦¬ìŠ¤íŠ¸ í•­ëª©ìœ¼ë¡œ ë¶„ë¦¬í•˜ì—¬ ë Œë”ë§
                const contentList = content.split('. ').filter(item => item.trim() !== '').map(item => `
                    <li class="mt-1 ml-4 text-sm text-gray-600 list-item list-disc">${item.trim().startsWith('*') ? item.trim().substring(1).trim() : item.trim()}</li>
                `).join('');

                return `
                    <div class="mb-4">
                        <h4 class="text-md font-bold text-gray-800 mb-2 border-b border-gray-100 pb-1">${sectionTitle}</h4>
                        <ul class="list-disc pl-5 space-y-1">${contentList || '<li class="text-sm text-gray-500 italic">- ê¸°ë¡ ì—†ìŒ</li>'}</ul>
                    </div>
                `;
            }).join('');

            return `
                <div class="history-card bg-white p-6 rounded-xl border border-gray-200">
                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-4 border-b pb-3">
                        <h2 class="text-xl font-extrabold text-blue-600">
                            ${history.version} <span class="text-lg text-gray-700 font-semibold">(${history.title})</span>
                        </h2>
                        <span class="text-sm font-medium text-gray-500 mt-2 sm:mt-0">
                            ${history.date}
                        </span>
                    </div>
                    <div>
                        ${sectionsHtml}
                    </div>
                </div>
            `;
        }

        /**
         * To-Do/WBS ë·°ë¥¼ ë Œë”ë§í•©ë‹ˆë‹¤. (ì²´í¬ë°•ìŠ¤ ëŒ€ì‹  ì•„ì´ì½˜ ì‚¬ìš©)
         */
        function renderTodo() {
            noResults.classList.add('hidden');
            let todoHtml = ``;

            if (todoData.length === 0) {
                 noResults.textContent = `í˜„ì¬ ì—°ê²°ëœ ì €ì¥ì†Œ(${CONNECTED_REPO_URL}, Branch: ${CONNECTED_BRANCH})ì—ì„œ íŒŒì‹±ëœ ìœ íš¨í•œ To-Do ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.`;
                 noResults.classList.remove('hidden');
                 contentArea.innerHTML = '';
                 return;
            }

            todoData.forEach(phase => {
                // Phase (Project/ì „ì²´ ì‘ì—…)
                const lastUpdatedHtml = phase.last_updated 
                    ? `<span class="ml-3 text-sm text-gray-500 font-normal">${phase.last_updated}</span>` 
                    : '';
                todoHtml += `
                    <div class="todo-card bg-white p-6 rounded-xl border border-gray-200 mb-8">
                        <div class="flex items-center mb-4 pb-3 border-b border-gray-100">
                            <!-- colorëŠ” í´ë˜ìŠ¤ ì´ë¦„ìœ¼ë¡œ ì§ì ‘ ì‚¬ìš©í•©ë‹ˆë‹¤. -->
                            <span class="${phase.color} text-white text-sm font-bold px-3 py-1 rounded-full mr-3">${phase.id}</span>
                            <h3 class="text-xl font-extrabold text-gray-900 flex items-center">${phase.title}${lastUpdatedHtml}</h3>
                        </div>
                `;

                phase.subtasks.forEach(subtask => {
                    // Subtask (Task ìƒì„¸ ëª©ë¡)
                    // subtask.idê°€ ìˆìœ¼ë©´ í‘œì‹œí•˜ê³ , ì—†ìœ¼ë©´(ë¹ˆ ë¬¸ìì—´) ê³µë°±ë„ ì—†ì´ ì œëª©ë§Œ í‘œì‹œ
                    const subtaskHeader = subtask.id 
                        ? `<h4 class="text-lg font-semibold text-gray-800 mb-3">${subtask.id} ${subtask.title}</h4>`
                        : `<h4 class="text-lg font-semibold text-gray-800 mb-3">${subtask.title}</h4>`;

                    todoHtml += `
                        <div class="ml-4 mt-4 p-4 border border-gray-100 rounded-lg bg-gray-50">
                            ${subtaskHeader}
                            <ul class="list-none space-y-2">
                    `;

                    subtask.tasks.forEach(task => {
                        if (task.type === 'text') {
                            // ì²´í¬ë°•ìŠ¤ê°€ ì—†ëŠ” ì¼ë°˜ í…ìŠ¤íŠ¸ (í—¤ë” ë“±)
                            let indentClass = '';
                            let styleClass = 'mt-4 mb-2 text-gray-800 font-bold border-b border-gray-100 pb-1 text-base';

                            if (/^\d+\.0/.test(task.content)) {
                                styleClass = 'mt-6 mb-3 text-gray-900 font-extrabold text-lg border-b-2 border-gray-200 pb-2';
                            } else if (/^\d+\.\d+/.test(task.content)) {
                                indentClass = 'ml-6';
                            }

                            todoHtml += `
                                <li class="${indentClass} ${styleClass}">
                                    ${task.content}
                                </li>
                            `;
                        } else {
                            // ì²´í¬ë°•ìŠ¤ê°€ ìˆëŠ” Task
                            const isCompleted = task.status === 'checked';
                            const icon = isCompleted ? 'âœ“' : 'âœ—';
                            const iconClass = isCompleted ? 'status-icon status-completed' : 'status-icon status-pending';
                            const descriptionClass = isCompleted ? 'line-through text-gray-500 italic' : 'text-gray-700';
                            
                            const idSpan = task.id ? `<span class="font-medium mr-2">${task.id}</span>` : '';

                            todoHtml += `
                                <li class="flex items-center text-base ml-12">
                                    <span class="${iconClass}" aria-label="${isCompleted ? 'Completed' : 'Pending'}">${icon}</span>
                                    <span class="${descriptionClass}">
                                        ${idSpan}${task.description}
                                    </span>
                                </li>
                            `;
                        }
                    });

                    todoHtml += `
                            </ul>
                        </div>
                    `;
                });

                todoHtml += `</div>`; // Close todo-card
            });

            contentArea.innerHTML = todoHtml;
        }

        /**
         * í”„ë¡œì íŠ¸ ëª©ë¡ ë·°ë¥¼ ë Œë”ë§í•©ë‹ˆë‹¤.
         */
        async function renderProjectList() {
            contentArea.innerHTML = '<p class="text-center text-gray-500 py-10">ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>';
            
            try {
                const response = await fetch('/api/history');
                const historyList = await response.json();
                
                if (historyList.length === 0) {
                    contentArea.innerHTML = '<p class="text-center text-gray-500 py-10">ì €ì¥ëœ í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                    return;
                }

                let html = `
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white border border-gray-200 rounded-lg shadow-sm">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">í”„ë¡œì íŠ¸ëª…</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ì €ì¥ì†Œ (Owner/Repo)</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Branch</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Token</th>
                                    <th class="py-3 px-4 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">ê´€ë¦¬</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                `;

                historyList.forEach((item, index) => {
                    const pName = item.project_name || `${item.owner}/${item.repo}`;
                    // [ìˆ˜ì •] ì¸ë¼ì¸ JS í˜¸ì¶œ ì‹œ ì‘ì€ë”°ì˜´í‘œ(')ê°€ ìˆìœ¼ë©´ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ë¯€ë¡œ ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬
                    const pNameEscaped = pName.replace(/'/g, "\\'");
                    const tokenStatus = item.token ? '<span class="text-green-600 font-bold">âœ“</span>' : '<span class="text-gray-400">-</span>';
                    
                    // JSON ê°ì²´ë¥¼ ë¬¸ìì—´ë¡œ ë³€í™˜í•˜ì—¬ data ì†ì„±ì— ì €ì¥ (ë”°ì˜´í‘œ ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬)
                    const itemJson = JSON.stringify(item).replace(/"/g, '&quot;');

                    html += `
                        <tr class="hover:bg-gray-50 transition">
                            <td class="py-3 px-4 text-sm font-bold text-gray-800">${pName}</td>
                            <td class="py-3 px-4 text-sm text-gray-600">
                                <a href="${item.url}" target="_blank" class="hover:text-blue-600 hover:underline">${item.owner}/${item.repo}</a>
                            </td>
                            <td class="py-3 px-4 text-sm text-gray-600">${item.branch}</td>
                            <td class="py-3 px-4 text-sm text-center">${tokenStatus}</td>
                            <td class="py-3 px-4 text-right text-sm space-x-2">
                                <button onclick="loadProject('${item.owner}', '${item.repo}', '${item.branch}', '${item.token || ''}', '${pNameEscaped}')" 
                                        class="bg-green-100 text-green-700 px-3 py-1 rounded hover:bg-green-200 font-medium">
                                    ë¶ˆëŸ¬ì˜¤ê¸°
                                </button>
                                <button onclick="openEditModal(${itemJson})" 
                                        class="bg-blue-100 text-blue-700 px-3 py-1 rounded hover:bg-blue-200 font-medium">
                                    ìˆ˜ì •
                                </button>
                                <button onclick="deleteProject('${item.url}', '${item.branch}')" 
                                        class="bg-red-100 text-red-700 px-3 py-1 rounded hover:bg-red-200 font-medium">
                                    ì‚­ì œ
                                </button>
                            </td>
                        </tr>
                    `;
                });

                html += `</tbody></table></div>`;
                contentArea.innerHTML = html;

            } catch (e) {
                console.error("Failed to fetch project list:", e);
                contentArea.innerHTML = '<p class="text-center text-red-500 py-10">ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
            }
        }

        /**
         * History ë·°ë¥¼ ë Œë”ë§í•©ë‹ˆë‹¤. ë‚ ì§œ í•„í„°ë§ ê¸°ëŠ¥ í¬í•¨.
         */
        function renderHistory(filterValue = '') {
            contentArea.innerHTML = '';
            const normalizedFilter = filterValue.trim();

            if (projectHistoryData.length === 0) {
                 noResults.textContent = `í˜„ì¬ ì—°ê²°ëœ ì €ì¥ì†Œ(${CONNECTED_REPO_URL}, Branch: ${CONNECTED_BRANCH})ì—ì„œ íŒŒì‹±ëœ ìœ íš¨í•œ History ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.`;
                 noResults.classList.remove('hidden');
                 return;
            }

            const filteredData = normalizedFilter
                // ë‚ ì§œ í•„í„°ë§: yyyy-mm-dd í˜•ì‹ìœ¼ë¡œ ë¹„êµ
                ? projectHistoryData.filter(item => item.date.startsWith(normalizedFilter)).sort((a, b) => new Date(b.date) - new Date(a.date))
                // ì „ì²´ ë³´ê¸°: ë‚ ì§œ ì—­ìˆœìœ¼ë¡œ ì •ë ¬
                : projectHistoryData.sort((a, b) => new Date(b.date) - new Date(a.date));

            if (filteredData.length === 0) {
                noResults.textContent = `í•´ë‹¹ ë‚ ì§œ (${normalizedFilter})ì— ì¼ì¹˜í•˜ëŠ” ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.`;
                noResults.classList.remove('hidden');
            } else {
                noResults.classList.add('hidden');
                filteredData.forEach(history => {
                    contentArea.innerHTML += renderHistoryCard(history);
                });
            }
        }

        // --- EVENT HANDLERS & INITIALIZATION ---
        
        /**
         * ë·° ì „í™˜ ë° UI ì—…ë°ì´íŠ¸
         */
        function switchView(viewType) {
            currentView = viewType;

            // íƒ­ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
            document.querySelectorAll('.view-tab').forEach(tab => {
                if (tab.dataset.view === viewType) {
                    tab.classList.add('tab-active');
                } else {
                    tab.classList.remove('tab-active');
                }
            });

            // í•„í„° UI í‘œì‹œ/ìˆ¨ê¹€
            filterContainer.classList.add('hidden');
            noResults.classList.add('hidden'); 
            contentArea.innerHTML = '';
            
            if (viewType === 'history') {
                filterContainer.classList.remove('hidden');
                // í˜„ì¬ í•„í„° ê°’ìœ¼ë¡œ History ë Œë”ë§
                renderHistory(dateFilterInput.value); 
            } else if (viewType === 'todo') {
                renderTodo();
            } else if (viewType === 'raw') {
                // Raw íŒŒì¼ ë·°ëŠ” í•„í„° UIë¥¼ ìˆ¨ê¹ë‹ˆë‹¤.
                renderRawFiles();
            } else if (viewType === 'projectList') {
                renderProjectList();
            }
        }


        // 1. GitHub URL ë° Branch Name ë¡œë“œ ë° ë³€ê²½ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        loadSettings();
        githubUrlInput.addEventListener('change', saveSettings);
        projectNameInput.addEventListener('change', saveSettings);
        branchNameInput.addEventListener('change', saveSettings);
        githubTokenInput.addEventListener('change', saveSettings);


        // 1.5. GitHub ì—°ê²° ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        connectButton.addEventListener('click', () => {
            const url = githubUrlInput.value;
            const pName = projectNameInput.value;
            const branch = branchNameInput.value;
            const repoInfo = parseGithubUrl(url);
            const token = githubTokenInput.value;

            if (repoInfo && branch.trim()) {
                // 1. URLê³¼ Branch ì €ì¥
                saveSettings();

                // 2. Flask ì„œë²„ì— ìƒˆë¡œìš´ ì €ì¥ì†Œ ì •ë³´ì™€ ë¸Œëœì¹˜ ì´ë¦„ìœ¼ë¡œ í˜ì´ì§€ë¥¼ ë¦¬ë¡œë“œ ìš”ì²­
                let targetUrl = `/?owner=${repoInfo.owner}&repo=${repoInfo.repo}&branch=${branch.trim()}&project_name=${encodeURIComponent(pName)}`;
                if (token.trim()) {
                    targetUrl += `&token=${token.trim()}`;
                }
                window.location.href = targetUrl;
            } else {
                // ê²½ê³  ë©”ì‹œì§€ë¥¼ ì‚¬ìš©ì ì •ì˜ UI ëŒ€ì‹  alertìœ¼ë¡œ í‘œì‹œ (ê°„ë‹¨í•œ êµ¬í˜„ì„ ìœ„í•´)
                alert('ìœ íš¨í•œ GitHub ì €ì¥ì†Œ URLê³¼ ë¸Œëœì¹˜ ì´ë¦„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
            }
        });


        // 2. íƒ­ ì „í™˜ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.querySelectorAll('.view-tab').forEach(tab => {
            tab.addEventListener('click', (e) => {
                // [ìˆ˜ì •] e.target ëŒ€ì‹  e.currentTargetì„ ì‚¬ìš©í•˜ì—¬ ë²„íŠ¼ ë‚´ë¶€(í…ìŠ¤íŠ¸ ë“±)ë¥¼ í´ë¦­í•´ë„ ë²„íŠ¼ì˜ data-viewë¥¼ ê°€ì ¸ì˜¤ë„ë¡ í•¨
                switchView(e.currentTarget.dataset.view);
            });
        });

        // 3. History í•„í„°ë§ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ: ê²€ìƒ‰ ë²„íŠ¼
        document.getElementById('filterButton').addEventListener('click', () => {
            if (currentView === 'history') {
                renderHistory(dateFilterInput.value);
            }
        });

        // 3. History í•„í„°ë§ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ: ì „ì²´ ë³´ê¸° ë²„íŠ¼
        document.getElementById('resetButton').addEventListener('click', () => {
            if (currentView === 'history') {
                dateFilterInput.value = ''; // í•„í„° ì…ë ¥ê°’ ì´ˆê¸°í™”
                renderHistory(); // ì „ì²´ ë³´ê¸° ë Œë”ë§
            }
        });

        // 3. History í•„í„°ë§ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ: ë‚ ì§œ ì…ë ¥ ë³€ê²½ ì‹œ ì¦‰ì‹œ í•„í„° ì ìš©
        dateFilterInput.addEventListener('change', () => {
            if (currentView === 'history') {
                renderHistory(dateFilterInput.value);
            }
        });

        // ì´ˆê¸° ë·° ë Œë”ë§
        if (isInitialLoad) {
             // ì—°ê²° ë²„íŠ¼ì„ ëˆ„ë¥´ì§€ ì•Šì€ ì´ˆê¸° ìƒíƒœì—ì„œëŠ” í”„ë¡¬í”„íŠ¸ ë©”ì‹œì§€ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.
             contentArea.innerHTML = `
                <div class="bg-white p-12 rounded-xl border-4 border-dashed border-gray-300 text-center space-y-4">
                    <!-- Icon: Bell/Notification -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto text-gray-400">
                        <path d="M15 17h5l-1.405-2.81C18.172 13.923 18 13.435 18 13v-3c0-2.31 1.9-4.31 4-4.82V5c0-1.1-.9-2-2-2h-1c-1.1 0-2 .9-2 2v.18C15.9 5.69 14 7.69 14 10v3c0 .435-.172.923-.595 1.19L12 17h3z"/>
                        <path d="M10 17h3l-1.405-2.81C11.172 13.923 11 13.435 11 13v-3c0-2.31 1.9-4.31 4-4.82V5c0-1.1-.9-2-2-2H9c-1.1 0-2 .9-2 2v.18C7.9 5.69 6 7.69 6 10v3c0 .435-.172.923-.595 1.19L4 17h3z"/>
                        <path d="M11 21h2m-1-4v4"/>
                    </svg>
                    <h3 class="text-2xl font-semibold text-gray-700">GitHub ì €ì¥ì†Œ ì—°ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤</h3>
                    <p class="text-gray-500">ìœ„ ì…ë ¥ì°½ì— GitHub ì €ì¥ì†Œ URLê³¼ ë¸Œëœì¹˜ ì´ë¦„ì„ ì…ë ¥í•˜ê³  <strong>GitHub ì—°ê²°</strong> ë²„íŠ¼ì„ ëˆŒëŸ¬ í”„ë¡œì íŠ¸ ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ì„¸ìš”.</p>
                </div>
            `;
            filterContainer.classList.add('hidden');
        } else {
            // ì—°ê²°ëœ ìƒíƒœ (í˜ì´ì§€ ë¦¬ë¡œë“œ í›„), History ë·°ë¡œ ì‹œì‘
            switchView('history');
        }

        // --- FLATPICKR INITIALIZATION ---
        // ë°ì´í„°ê°€ ìˆëŠ” ë‚ ì§œ ëª©ë¡ ì¶”ì¶œ
        const availableDates = projectHistoryData.map(item => item.date);
        
        // Flatpickr ë‹¬ë ¥ ì´ˆê¸°í™”
        flatpickr("#dateFilter", {
            locale: "ko",
            dateFormat: "Y-m-d",
            allowInput: true,
            onDayCreate: function(dObj, dStr, fp, dayElem) {
                // ë‚ ì§œ ë¹„êµë¥¼ ìœ„í•´ YYYY-MM-DD í˜•ì‹ìœ¼ë¡œ ë³€í™˜
                const year = dayElem.dateObj.getFullYear();
                const month = String(dayElem.dateObj.getMonth() + 1).padStart(2, '0');
                const day = String(dayElem.dateObj.getDate()).padStart(2, '0');
                const formattedDate = `${year}-${month}-${day}`;
                
                if (availableDates.includes(formattedDate)) {
                    dayElem.classList.add('has-event');
                    dayElem.title = "ê¸°ë¡ ìˆìŒ";
                }
            },
            onChange: function(selectedDates, dateStr, instance) {
                if (currentView === 'history') {
                    renderHistory(dateStr);
                }
            }
        });

        // --- AUTO SHUTDOWN HEARTBEAT ---
        // 1ì´ˆë§ˆë‹¤ ì„œë²„ì— ìƒì¡´ ì‹ í˜¸ë¥¼ ë³´ëƒ…ë‹ˆë‹¤. ì°½ì„ ë‹«ìœ¼ë©´ ì‹ í˜¸ê°€ ëŠê²¨ ì„œë²„ê°€ ì¢…ë£Œë©ë‹ˆë‹¤.
        setInterval(() => {
            fetch('/heartbeat').catch(() => {});
        }, 1000);

        // --- PROJECT LIST ACTIONS ---
        
        // 1. ë¶ˆëŸ¬ì˜¤ê¸° (Load)
        window.loadProject = function(owner, repo, branch, token, pName) {
            // ì…ë ¥ì°½ ì—…ë°ì´íŠ¸
            githubUrlInput.value = `https://github.com/${owner}/${repo}`;
            branchNameInput.value = branch;
            githubTokenInput.value = token;
            projectNameInput.value = pName;
            saveSettings();
            
            // í˜ì´ì§€ ì´ë™
            let targetUrl = `/?owner=${owner}&repo=${repo}&branch=${branch}&project_name=${encodeURIComponent(pName)}`;
            if (token) targetUrl += `&token=${token}`;
            window.location.href = targetUrl;
        };

        // 2. ì‚­ì œ (Delete)
        window.deleteProject = async function(url, branch) {
            if (!confirm('ì •ë§ ì´ í”„ë¡œì íŠ¸ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            try {
                const response = await fetch('/api/history/delete', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ url: url, branch: branch })
                });
                if (response.ok) {
                    renderProjectList(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                } else {
                    alert('ì‚­ì œ ì‹¤íŒ¨');
                }
            } catch (e) {
                console.error(e);
                alert('ì˜¤ë¥˜ ë°œìƒ');
            }
        };

        // --- EDIT MODAL LOGIC ---
        function toggleEditModal() {
            const body = document.querySelector('body');
            editModal.classList.toggle('opacity-0');
            editModal.classList.toggle('pointer-events-none');
            body.classList.toggle('modal-active');
        }

        window.openEditModal = function(item) {
            document.getElementById('editOriginalUrl').value = item.url;
            document.getElementById('editOriginalBranch').value = item.branch;
            
            document.getElementById('editProjectName').value = item.project_name || `${item.owner}/${item.repo}`;
            document.getElementById('editUrl').value = item.url;
            document.getElementById('editBranch').value = item.branch;
            document.getElementById('editToken').value = item.token || '';
            
            toggleEditModal();
        };

        saveEditBtn.addEventListener('click', async () => {
            const originalUrl = document.getElementById('editOriginalUrl').value;
            const originalBranch = document.getElementById('editOriginalBranch').value;
            
            const newUrl = document.getElementById('editUrl').value;
            const repoInfo = parseGithubUrl(newUrl);
            if (!repoInfo) {
                alert("ìœ íš¨í•œ GitHub URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }

            const newData = {
                project_name: document.getElementById('editProjectName').value,
                url: newUrl,
                owner: repoInfo.owner,
                repo: repoInfo.repo,
                branch: document.getElementById('editBranch').value,
                token: document.getElementById('editToken').value || null,
                date: new Date().toISOString().replace('T', ' ').substring(0, 19) // í˜„ì¬ ì‹œê°„ ê°±ì‹ 
            };

            try {
                const response = await fetch('/api/history/update', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        original_url: originalUrl,
                        original_branch: originalBranch,
                        new_data: newData
                    })
                });
                
                if (response.ok) {
                    toggleEditModal();
                    renderProjectList(); // ëª©ë¡ ê°±ì‹ 
                } else {
                    alert("ìˆ˜ì • ì‹¤íŒ¨");
                }
            } catch (e) {
                console.error(e);
                alert("ì˜¤ë¥˜ ë°œìƒ");
            }
        });

        editModalCloseBtn.addEventListener('click', toggleEditModal);
        cancelEditBtn.addEventListener('click', toggleEditModal);
        document.querySelector('.modal-overlay').addEventListener('click', toggleEditModal);
    </script>
</body>
</html>